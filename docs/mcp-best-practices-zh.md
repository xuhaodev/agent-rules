---
description: 开发模型上下文协议（MCP）工具的最佳实践，包含适当的配置和行为
globs: "*.mcp, mcp-*/**"
alwaysApply: false
---

# MCP 最佳实践 - 2025年5月26日

**I. 工具配置和行为通用规则**

1.  **合理的默认值：** 所有环境变量必须有合理的默认值，以便开箱即用。
2.  **动态版本控制：** 工具的版本在其描述中输出。此版本必须动态读取（例如，从 `package.json`），而不是硬编码。
3.  **工具和参数描述：**
    *   **工具标题：** 为工具使用描述性的、人性化的标题。
    *   **参数描述：** 所有参数必须提供清晰的描述。
    *   **可选/必需参数：** 参数必须明确标注为"可选"或"必需"。
    *   **默认值：** 如果参数是可选的，必须解释其默认值。
    *   （这些详细信息应通过在 Cursor 等客户端中悬停工具或使用 MCP 检查器来验证。）
4.  **参数解析：** 参数解析应该宽松（例如，如果正式定义了 `project_path`，则接受 `path`）。通常，宣传更严格的模式，但在执行中更宽松，以适应代理的变化。
5.  **运行时错误处理：** 在出现错误时，向调用者发出有用的消息，提供可能恢复的信息。
6.  **配置错误处理：** 配置错误（例如，错误设置的环境变量）不得使工具崩溃。相反，在运行工具时提供有用的解释，使用户能够自行纠正设置。
7.  **无标准输出：** **关键：在任何工具操作期间绝对不得有标准输出或标准错误输出。** 这包括：
    *   不能有 `console.log()`、`console.error()`、`console.warn()` 等
    *   不能有 `process.stdout.write()` 或 `process.stderr.write()`
    *   不能有打印语句或调试输出到标准输入输出
    *   即使在错误或初始化期间，所有输出必须通过文件记录器
    *   任何标准输入输出都会干扰 MCP 客户端（如 Claude）并导致加载错误
    *   基于文件的日志记录（例如，Pino 到日志文件）是唯一可接受的操作输出方法
8.  **`info` 命令：**
    *   至少一个工具必须提供 `info` 子命令（找到最合适的工具并在那里添加）
    *   此命令应列出：
        *   MCP 工具的版本。
        *   任何必需的本机依赖项的状态（如果适用），包括其存在和功能的测试。
        *   任何检测到的配置问题或缺失的环境变量（例如，记录器路径的问题）。

**II. 日志记录（Pino）**

1.  **默认文件记录器：** Pino 用于日志记录，在系统日志目录（例如，`~/Library/Logs/`）中使用默认文件记录器。日志文件路径可通过 `[ProjectName]_LOG_FILE` 环境变量配置。
2.  **日志路径弹性：**
    *   Pino 逻辑必须自动为指定的日志文件路径创建缺失的父目录。
    *   如果 pino 无法写入 `[ProjectName]_LOG_FILE` 路径，必须回退到记录到默认临时目录路径。
3.  **可配置日志级别：** 日志级别使用 `[ProjectName]_LOG_LEVEL` 环境变量设置（接受大写、小写或混合大小写值）。
4.  **可选控制台日志记录：** 环境变量 `[ProjectName]_CONSOLE_LOGGING=true` 除了 pino 文件记录器外，还启用到控制台的日志记录。
5.  **记录器刷新：** 记录器必须在进程退出前刷新，以确保所有日志消息都被写入。

**III. 代码、依赖项和构建**

1.  **依赖项管理：** 所有依赖项应保持在最新的稳定版本。（发布脚本将警告过时的依赖项）。
2.  **静态分析：** 不得有 linter（例如，ESLint）或 TypeScript 错误。
3.  **文件大小：** 单个文件不应超过 500 行代码（LOC）；目标是低于 300 LOC。
4.  **使用编译代码执行：** 启动逻辑和所有工具操作必须始终使用编译的 JavaScript 输出（例如，来自 `dist` 文件夹）。
5.  **Shebangs：** 用于直接执行的编译 JavaScript 文件必须有正确的 shebang（例如，`#!/usr/bin/env node`）。
6.  **NPM 包内容：** 发布的 npm 包必须只包含绝对最少的文件：`dist/` 文件夹、任何潜在的本机组件、`README.md` 和 `LICENSE` 文件。

**IV. 测试**

1.  **测试框架：** 测试必须使用 `vitest`。
2.  **TypeScript 测试套件：** 需要 TypeScript 层的综合测试套件。
3.  **端到端（E2E）测试：** 需要验证完整设置的 E2E 测试。（如果由于权限（如 macOS 访问）导致 CI 执行困难，这些可能作为发布准备运行）。
4.  **NPM 脚本：**
    *   `npm run prepare-release` 执行综合测试套件（在第 VI 节中详述）。
    *   `npm run inspector` 执行 `npx @modelcontextprotocol/inspector node path/to/server/index.js`。

**V. 本机二进制规则（如果适用）**

1.  **macOS 兼容性：** 二进制必须是通用的（Apple Silicon 和 Intel）并支持当前 macOS 版本和前一个主要版本（n-1，例如，如果当前是 15，则 macOS >= 14）。
2.  **构建优化：** 必须设置编译器和链接器标志以实现最小的二进制文件大小。
3.  **本机测试套件：** 需要使用 Swift 的本机测试工具（例如，`swift-test` 或 XCTest）的综合测试套件。
4.  **自定义路径配置：** 环境变量必须允许设置运行本机二进制的自定义绝对路径。
5.  **错误通信：** 如果工具使用本机库，必须使用 `errno`（或等效机制）将错误和执行问题传递给 TypeScript 记录器并返回给工具。
6.  **版本同步：** 本机 CLI 和 MCP 工具（TypeScript 包）必须具有相同的版本号。此版本必须在构建过程中注入，而不是硬编码，同时仍允许简单的开发（例如，在 Xcode 中使用当前源代码，脚本在构建时替换版本）。
7.  **本机代码质量：**
    *   CLI 不得有 linter 问题（例如，Swift 的 SwiftLint）。
    *   必须应用格式化程序（例如，Swift 的 SwiftFormat）。
    *   CLI 不得显示分析器问题。
8.  **JSON 通信：** 工具的本机二进制部分必须有一种模式，以 JSON 格式与 TypeScript 服务器通信，以便更容易解析。如果请求（例如，通过传递日志级别），JSON 响应应包括调试日志。
9.  **CLI 帮助命令：** 二进制必须对 `--help` 响应有用的命令，解释其使用和所有选项。
10. **参数解析框架：** 二进制必须使用强大的参数解析器框架（例如，Swift 的 `swift-argument-parser`）。
11. **单文件分发：** 对于本机 CLI，考虑分发为单个静态链接二进制的选项，如果可行且对最终用户简化安装有益，他们可能直接使用 CLI。

**VI. 发布前检查规则（`scripts/prepare-release.js`）**

*   有一个 `scripts/prepare-release.js` 运行广泛的测试套件。脚本按顺序运行这些检查，并在第一次失败时停止。

    **Git 和版本控制：**
    1.  检查当前分支（如果不在 main 或指定的发布分支上，则警告）。
    2.  检查未提交的更改。
    3.  检查是否与 origin/main（或指定的发布分支）同步。
    4.  版本可用性检查（确保版本尚未发布）。
    5.  `package.json` 和 `package-lock.json` 之间的版本一致性。
    6.  **变更日志检查：** 检查对应当前版本的变更日志条目。

    **代码质量和安全性：**
    1.  依赖项安装检查。
    2.  过时依赖项检查（仅警告）。
    3.  安全审计（在关键/高漏洞上失败）。
    4.  TypeScript 编译。
    5.  TypeScript 测试。
    6.  TypeScript 声明文件生成。
    7.  在构建前删除任何构建文件夹并重置包缓存。
    8.  *如果存在本机二进制：* Swift 分析。
    9.  *如果存在本机二进制：* Swift 格式化（SwiftFormat）。
    10. *如果存在本机二进制：* Swift linting（SwiftLint）。
    11. *如果存在本机二进制：* Swift 测试。
    12. 无构建警告。

    **二进制和 CLI 验证（如果适用）：**
    13. *如果存在本机二进制：* Swift CLI 命令测试（帮助、版本和其他关键功能）。
    14. *如果存在本机二进制：* Swift CLI 错误处理测试（无效命令、缺失参数、无效窗口索引等）。
    15. *如果存在本机二进制：* Swift CLI JSON 输出验证。
    16. *如果存在本机二进制：* 二进制存在且可执行。
    17. *如果存在本机二进制：* 二进制包含两种架构（arm64 + x86_64，可通过 `lipo -info` 验证）。
    18. *如果存在本机二进制：* 二进制正确响应 `--help`。

    **包验证：**
    19. `package.json` 中的必需字段。
    20. 包大小检查（如果 >2MB 则警告，可配置阈值）。
    21. `postinstall` 中的可执行权限检查（如果存在 CLI）。
    22. 包含关键文件（例如，`dist/index.js`、本机二进制名称、`README.md`、`LICENSE`）。
    23. MCP 服务器冒烟测试（JSON-RPC 请求/响应）。
    24. 完整集成测试。

*   发布首先使用 `beta` 标签到 npm 注册表，以便可以通过 `npx [packageName]@beta install` 方法进行测试。
